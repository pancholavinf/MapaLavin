<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Análisis Electoral - Mapa Electoral de Chile</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="geojeson.js"></script>
</head>

<body class="analysis-mode">

    <div id="container">
        <div id="sidebar" class="wide-sidebar">
            <div class="header-nav">
                <a href="index.html" class="back-link">← Volver al Mapa</a>
                <h2>Análisis y Comparación</h2>
            </div>

            <div class="analysis-controls">
                <div class="control-group">
                    <label>Modo:</label>
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="compare">Comparar Elecciones</button>
                        <button class="mode-btn" data-mode="candidate">Analizar Candidato</button>
                    </div>
                </div>
            </div>

            <div id="compare-view" class="analysis-view active">
                <div class="selection-area">
                    <div class="select-box">
                        <label>Elección 1</label>
                        <select id="eleccion-1" class="eleccion-select">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="select-box">
                        <label>Elección 2</label>
                        <select id="eleccion-2" class="eleccion-select">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </div>
                <div id="comparison-results">
                    <p class="placeholder-text">Selecciona dos elecciones para comparar sus resultados.</p>
                </div>
            </div>

            <div id="candidate-view" class="analysis-view">
                <div class="selection-area">
                    <div class="select-box full-width">
                        <label>Buscar Candidato</label>
                        <input type="text" id="candidate-search" placeholder="Escribe el nombre del candidato...">
                        <div id="candidate-suggestions" class="suggestions-list"></div>
                    </div>
                </div>
                <div id="candidate-details">
                    <p class="placeholder-text">Busca un candidato para ver su historial y mapa de calor.</p>
                </div>
            </div>

        </div>
        <div id="map"></div>
    </div>

    <script>
        // Initialize Map
        const map = L.map('map').setView([-38, -72], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        let geojsonLayer = L.geoJson(chileGeoJson, {
            style: { color: "#4a4a4a", weight: 1, opacity: 0.6, fillColor: "#dcdcdc", fillOpacity: 0.5 },
            onEachFeature: (f, l) => {
                l.bindTooltip(f.properties.nomregion, { sticky: true });
            }
        }).addTo(map);

        // State
        let eleccionesData = [];
        let candidatosData = []; // Cache for search

        // DOM Elements
        const eleccion1Select = document.getElementById('eleccion-1');
        const eleccion2Select = document.getElementById('eleccion-2');
        const candidateSearch = document.getElementById('candidate-search');
        const candidateSuggestions = document.getElementById('candidate-suggestions');

        // Load Initial Data
        document.addEventListener('DOMContentLoaded', async () => {
            const res = await fetch('api/elecciones.json');
            eleccionesData = await res.json();

            eleccionesData.forEach(e => {
                const opt = new Option(e.nombre_eleccion, e.id_eleccion);
                eleccion1Select.add(opt.cloneNode(true));
                eleccion2Select.add(opt.cloneNode(true));
            });

            loadAllCandidates();
        });

        async function loadAllCandidates() {
            const allCandidatos = new Map();

            for (const el of eleccionesData) {
                try {
                    const res = await fetch(`api/candidatos/${el.id_eleccion}.json`);
                    const cands = await res.json();
                    cands.forEach(c => {
                        if (!allCandidatos.has(c.nombre_completo)) {
                            allCandidatos.set(c.nombre_completo, { ...c, elecciones: [] });
                        }
                        allCandidatos.get(c.nombre_completo).elecciones.push(el.id_eleccion);
                    });
                } catch (e) { console.warn('No candidates for', el.id_eleccion); }
            }
            candidatosData = Array.from(allCandidatos.values());
        }

        // Mode Switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.analysis-view').forEach(v => v.classList.remove('active'));

                e.target.classList.add('active');
                document.getElementById(`${e.target.dataset.mode}-view`).classList.add('active');

                resetMap();
            });
        });

        // Comparison Logic
        [eleccion1Select, eleccion2Select].forEach(sel => {
            sel.addEventListener('change', compareElections);
        });

        async function compareElections() {
            const id1 = eleccion1Select.value;
            const id2 = eleccion2Select.value;
            const container = document.getElementById('comparison-results');

            if (!id1 || !id2) return;

            container.innerHTML = '<p class="loader">Cargando datos...</p>';

            try {
                const [res1, res2, stats1, stats2, cands1, cands2] = await Promise.all([
                    fetch(`api/resultados/pais/${id1}.json`).then(r => r.json()),
                    fetch(`api/resultados/pais/${id2}.json`).then(r => r.json()),
                    fetch(`api/estadisticas/pais/${id1}.json`).then(r => r.json()).catch(() => null),
                    fetch(`api/estadisticas/pais/${id2}.json`).then(r => r.json()).catch(() => null),
                    fetch(`api/candidatos/${id1}.json`).then(r => r.json()).catch(() => []),
                    fetch(`api/candidatos/${id2}.json`).then(r => r.json()).catch(() => [])
                ]);

                renderComparison(res1, res2, id1, id2, stats1, stats2, cands1, cands2);
            } catch (e) {
                container.innerHTML = '<p class="error">Error al cargar datos.</p>';
            }
        }

        function renderComparison(data1, data2, id1, id2, stats1, stats2, cands1, cands2) {
            const container = document.getElementById('comparison-results');
            const name1 = eleccionesData.find(e => e.id_eleccion == id1).nombre_eleccion;
            const name2 = eleccionesData.find(e => e.id_eleccion == id2).nombre_eleccion;

            let html = `
            <div class="comparison-grid">
                <div class="comp-col">
                    <h3>${name1}</h3>
                    ${renderMiniTable(data1)}
                </div>
                <div class="comp-col">
                    <h3>${name2}</h3>
                    ${renderMiniTable(data2)}
                </div>
            </div>
            
            <div class="charts-row">
                <div class="chart-box">
                    <h4>Espectro Político (Izquierda vs Centro vs Derecha)</h4>
                    <div style="height: 250px;"><canvas id="spectrum-chart"></canvas></div>
                </div>
                <div class="chart-box">
                    <h4>Participación Electoral</h4>
                    <div style="height: 250px;"><canvas id="participation-chart"></canvas></div>
                </div>
            </div>
        `;
            container.innerHTML = html;

            setTimeout(() => {
                renderSpectrumChart(data1, data2, cands1, cands2, name1, name2);
                renderParticipationChart(stats1, stats2, name1, name2);
            }, 100);
        }

        function renderMiniTable(data) {
            const total = data.reduce((s, r) => s + Number(r.total_votos), 0);
            return `
            <table class="mini-table">
                ${data.map(r => `
                    <tr>
                        <td><span class="color-dot" style="background:${r.color_hex}"></span> ${r.nombre_completo}</td>
                        <td class="text-right">${((Number(r.total_votos) / total) * 100).toFixed(1)}%</td>
                    </tr>
                `).join('')}
            </table>
        `;
        }

        function renderSpectrumChart(data1, data2, cands1, cands2, name1, name2) {
            const ctx = document.getElementById('spectrum-chart').getContext('2d');

            const processSpectrum = (data, cands) => {
                const spectrum = { 'Izquierda': 0, 'Centro': 0, 'Derecha': 0, 'Independiente': 0 };
                data.forEach(r => {
                    const cand = cands.find(c => c.nombre_completo === r.nombre_completo);
                    const tendency = cand ? (cand.tendencia || 'Independiente') : 'Independiente';
                    if (spectrum[tendency] !== undefined) {
                        spectrum[tendency] += Number(r.total_votos);
                    } else {
                        spectrum['Independiente'] += Number(r.total_votos);
                    }
                });
                return spectrum;
            };

            const s1 = processSpectrum(data1, cands1);
            const s2 = processSpectrum(data2, cands2);

            const labels = ['Izquierda', 'Centro', 'Derecha'];
            const ds1 = labels.map(l => s1[l]);
            const ds2 = labels.map(l => s2[l]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: name1, data: ds1, backgroundColor: '#3b82f6' },
                        { label: name2, data: ds2, backgroundColor: '#ef4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderParticipationChart(stats1, stats2, name1, name2) {
            const ctx = document.getElementById('participation-chart').getContext('2d');

            const p1 = stats1 ? (Number(stats1.total_votantes) / Number(stats1.total_electores) * 100) : 0;
            const p2 = stats2 ? (Number(stats2.total_votantes) / Number(stats2.total_electores) * 100) : 0;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [name1, name2],
                    datasets: [{
                        label: '% Participación',
                        data: [p1, p2],
                        backgroundColor: ['#3b82f6', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        // Candidate Analysis & Heatmap Logic
        candidateSearch.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (term.length < 2) { candidateSuggestions.innerHTML = ''; return; }

            const matches = candidatosData.filter(c => c.nombre_completo.toLowerCase().includes(term)).slice(0, 5);
            candidateSuggestions.innerHTML = matches.map(c => `
            <div class="suggestion-item" onclick="analyzeCandidate('${c.nombre_completo}')">
                ${c.nombre_completo} <small>(${c.nombre_partido || 'Ind.'})</small>
            </div>
        `).join('');
        });

        window.analyzeCandidate = async (name) => {
            candidateSuggestions.innerHTML = '';
            candidateSearch.value = name;
            const candidate = candidatosData.find(c => c.nombre_completo === name);
            const container = document.getElementById('candidate-details');

            if (!candidate) return;

            container.innerHTML = '<p class="loader">Analizando historial...</p>';

            const history = [];
            const regionVotes = new Map();

            for (const idEleccion of candidate.elecciones) {
                const natRes = await fetch(`api/resultados/pais/${idEleccion}.json`).then(r => r.json());
                const stats = await fetch(`api/estadisticas/pais/${idEleccion}.json`).then(r => r.json()).catch(() => ({ total_votantes: 0 }));

                const myRes = natRes.find(r => r.nombre_completo === name);
                if (myRes) {
                    const totalVotosEleccion = natRes.reduce((s, x) => s + Number(x.total_votos), 0);
                    history.push({
                        election: idEleccion,
                        ...myRes,
                        pct: (Number(myRes.total_votos) / totalVotosEleccion) * 100
                    });
                }

                const regions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];
                await Promise.all(regions.map(async (rId) => {
                    try {
                        const rData = await fetch(`api/resultados/region/${idEleccion}/${rId}.json`).then(r => r.json());
                        const cData = rData.find(r => r.nombre_completo === name);
                        if (cData) {
                            const total = rData.reduce((s, x) => s + Number(x.total_votos), 0);
                            if (!regionVotes.has(rId)) regionVotes.set(rId, []);
                            regionVotes.get(rId).push({ pct: Number(cData.total_votos) / total });
                        }
                    } catch (e) { }
                }));
            }

            container.innerHTML = `
            <div class="candidate-profile">
                <div class="profile-header">
                    <h3>${candidate.nombre_completo}</h3>
                    <span class="party-badge" style="background-color: ${candidate.color_hex || '#ccc'}">${candidate.nombre_partido || 'Independiente'}</span>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-box">
                        <h4>Historial de Votos</h4>
                        <div style="height: 250px;"><canvas id="history-chart"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <h4>Desempeño Regional (Promedio)</h4>
                        <div style="height: 250px;"><canvas id="regional-chart"></canvas></div>
                    </div>
                </div>

                <div class="history-list">
                    <h4>Historial Electoral</h4>
                    ${history.map(h => `
                        <div class="history-item">
                            <span>${eleccionesData.find(e => e.id_eleccion == h.election).nombre_eleccion}</span>
                            <strong>${Number(h.total_votos).toLocaleString('es-CL')} votos (${h.pct.toFixed(1)}%)</strong>
                        </div>
                    `).join('')}
                </div>

                <div class="heatmap-legend">
                    <h4>Mapa de Calor (Promedio Histórico)</h4>
                    <div class="gradient-bar" style="background: linear-gradient(to right, #eee, ${candidate.color_hex || '#333'})"></div>
                    <div class="legend-labels"><span>Menos Votos</span><span>Más Votos</span></div>
                </div>
            </div>
        `;

            renderHistoryChart(history, candidate.color_hex);
            renderRegionalChart(regionVotes, candidate.color_hex);
            updateHeatmap(regionVotes, candidate.color_hex || '#333333');
        };

        function renderHistoryChart(history, color) {
            const ctx = document.getElementById('history-chart').getContext('2d');
            history.sort((a, b) => a.election - b.election);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: history.map(h => eleccionesData.find(e => e.id_eleccion == h.election).nombre_eleccion),
                    datasets: [
                        {
                            label: 'Votos',
                            data: history.map(h => h.total_votos),
                            backgroundColor: (color || '#3b82f6'),
                            order: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: '% Votos',
                            data: history.map(h => h.pct),
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            type: 'line',
                            order: 1,
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: { display: true, text: 'Total Votos' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Porcentaje (%)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderRegionalChart(regionVotesMap, color) {
            const ctx = document.getElementById('regional-chart').getContext('2d');
            const labels = [];
            const data = [];

            const regionNames = {};
            geojsonLayer.eachLayer(l => regionNames[l.feature.properties.codregion] = l.feature.properties.nomregion);

            const sortedIds = Array.from(regionVotesMap.keys()).sort((a, b) => a - b);

            sortedIds.forEach(rId => {
                const votes = regionVotesMap.get(rId);
                const avg = votes.reduce((s, v) => s + v.pct, 0) / votes.length;
                labels.push(regionNames[rId] || `Reg ${rId}`);
                data.push((avg * 100).toFixed(2));
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Promedio',
                        data: data,
                        backgroundColor: color || '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { maxRotation: 90, minRotation: 90, font: { size: 10 } } }
                    }
                }
            });
        }

        function updateHeatmap(regionVotesMap, baseColor) {
            const regionavgs = new Map();
            let minPct = 1, maxPct = 0;

            regionVotesMap.forEach((votes, rId) => {
                const avg = votes.reduce((s, v) => s + v.pct, 0) / votes.length;
                regionavgs.set(rId, avg);
                if (avg < minPct) minPct = avg;
                if (avg > maxPct) maxPct = avg;
            });

            const scale = chroma.scale(['#f3f4f6', baseColor]).domain([minPct, maxPct]);

            geojsonLayer.eachLayer(layer => {
                const rId = parseInt(layer.feature.properties.codregion);
                const avg = regionavgs.get(rId);

                if (avg !== undefined) {
                    layer.setStyle({
                        fillColor: scale(avg).hex(),
                        fillOpacity: 0.8,
                        weight: 2,
                        color: '#fff'
                    });
                    layer.bindTooltip(`
                    <strong>${layer.feature.properties.nomregion}</strong><br>
                    Promedio: ${(avg * 100).toFixed(2)}%
                `);
                } else {
                    layer.setStyle({ fillColor: '#dcdcdc', fillOpacity: 0.3 });
                }
            });
        }

        function resetMap() {
            geojsonLayer.eachLayer(l => l.setStyle({ fillColor: "#dcdcdc", fillOpacity: 0.5, weight: 1 }));
        }
    </script>
</body>

</html>